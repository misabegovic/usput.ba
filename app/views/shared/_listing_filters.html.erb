<%# Shared listing filters partial
   Local variables:
   - filter_path: The path to submit filters to (required)
   - show_nearby: Whether to show the nearby filter (default: true)
   - show_city: Whether to show the city filter (default: true)
   - city_names: Array of city name strings for the dropdown (optional)
   - selected_city_name: Currently selected city name (optional)
   - show_type: Whether to show type filter (locations only)
   - location_types: Array of location types (optional)
   - show_budget: Whether to show budget filter (locations only)
   - budgets: Array of budget levels (optional)
   - show_duration: Whether to show duration filter (experiences/plans)
   - show_category: Whether to show category filter (experiences only)
   - categories: Array of categories (optional)
   - show_audio: Whether to show audio filter (locations only)
   - show_rating: Whether to show rating filter (default: true)
   - nearby_active: Whether nearby is currently active
   - has_active_filters: Whether any filters are currently active
%>

<% show_nearby = local_assigns.fetch(:show_nearby, true) %>
<% show_city = local_assigns.fetch(:show_city, true) %>
<% show_rating = local_assigns.fetch(:show_rating, true) %>
<% city_names = local_assigns.fetch(:city_names, []) %>
<% nearby_active = local_assigns.fetch(:nearby_active, false) %>
<% has_active_filters = local_assigns.fetch(:has_active_filters, false) %>

<div class="mb-8" data-controller="listing-filters">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 sm:p-6">
    <%# Mobile filter toggle button %>
    <button type="button"
            data-action="click->listing-filters#toggleFilters"
            data-listing-filters-target="toggleButton"
            class="md:hidden w-full flex items-center justify-between px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium">
      <span class="inline-flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
        </svg>
        <%= t("filters.filters", default: "Filters") %>
        <% if has_active_filters %>
          <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-600 rounded-full">
            <%= [nearby_active, params[:city_name].present?, params[:type].present?, params[:budget].present?, params[:category_id].present?, params[:duration].present?, params[:has_audio].present?, params[:min_rating].present?].count(true) %>
          </span>
        <% end %>
      </span>
      <svg data-listing-filters-target="toggleIcon" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>

    <%# Filter content - hidden on mobile by default, always visible on desktop %>
    <div data-listing-filters-target="filterContent" class="hidden md:block mt-4 md:mt-0">
      <%= form_tag filter_path, method: :get, data: { listing_filters_target: "form" }, class: "space-y-4" do %>
        <%# Main filters row %>
        <div class="flex flex-wrap gap-3 items-center">
        <%# Nearby button - primary filter %>
        <% if show_nearby %>
          <div class="relative">
            <button type="button"
                    data-action="click->listing-filters#requestNearby"
                    data-listing-filters-target="nearbyButton"
                    class="inline-flex items-center px-4 py-2.5 rounded-xl font-medium transition-all <%= nearby_active ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600' %>">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              <%= t("filters.nearby", default: "Nearby") %>
            </button>
            <% if nearby_active %>
              <button type="button"
                      data-action="click->listing-filters#clearNearby"
                      data-listing-filters-target="clearNearby"
                      class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center hover:bg-red-600">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            <% end %>
          </div>
          <div data-listing-filters-target="nearbyCoords">
            <input type="hidden" name="lat" value="<%= params[:lat] %>">
            <input type="hidden" name="lng" value="<%= params[:lng] %>">
          </div>
        <% end %>

        <%# City filter %>
        <% if show_city && city_names.any? %>
          <select name="city_name"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.all_cities", default: "All Cities") %></option>
            <% city_names.each do |name| %>
              <option value="<%= name %>" <%= 'selected' if params[:city_name] == name %>><%= name %></option>
            <% end %>
          </select>
        <% end %>

        <%# Location type filter (locations only) %>
        <% if local_assigns[:show_type] && local_assigns[:location_types]&.any? %>
          <select name="type"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.all_types", default: "All Types") %></option>
            <% local_assigns[:location_types].each do |type| %>
              <option value="<%= type %>" <%= 'selected' if params[:type] == type %>><%= t("locations.types.#{type}", default: type.humanize) %></option>
            <% end %>
          </select>
        <% end %>

        <%# Budget filter (locations only) %>
        <% if local_assigns[:show_budget] && local_assigns[:budgets]&.any? %>
          <select name="budget"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.all_budgets", default: "All Budgets") %></option>
            <% local_assigns[:budgets].each do |budget| %>
              <option value="<%= budget %>" <%= 'selected' if params[:budget] == budget %>><%= t("locations.budget.#{budget}", default: budget.humanize) %></option>
            <% end %>
          </select>
        <% end %>

        <%# Category filter (experiences only) %>
        <% if local_assigns[:show_category] && local_assigns[:categories]&.any? %>
          <select name="category_id"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.all_categories", default: "All Categories") %></option>
            <% local_assigns[:categories].each do |category| %>
              <option value="<%= category.uuid %>" <%= 'selected' if params[:category_id].to_s == category.uuid %>><%= category.name %></option>
            <% end %>
          </select>
        <% end %>

        <%# Duration filter (experiences and plans) %>
        <% if local_assigns[:show_duration] %>
          <select name="duration"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.any_duration", default: "Any Duration") %></option>
            <option value="short" <%= 'selected' if params[:duration] == 'short' %>><%= t("filters.duration_short", default: "Short (< 1h)") %></option>
            <option value="medium" <%= 'selected' if params[:duration] == 'medium' %>><%= t("filters.duration_medium", default: "Medium (1-3h)") %></option>
            <option value="long" <%= 'selected' if params[:duration] == 'long' %>><%= t("filters.duration_long", default: "Long (3h+)") %></option>
          </select>
        <% end %>

        <%# Audio filter (locations only) %>
        <% if local_assigns[:show_audio] %>
          <label class="inline-flex items-center px-4 py-2.5 rounded-xl cursor-pointer <%= params[:has_audio].present? ? 'bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600' %> transition-all">
            <input type="checkbox" name="has_audio" value="true" class="sr-only" data-action="change->listing-filters#filterChanged" <%= 'checked' if params[:has_audio].present? %>>
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.728-2.728"></path>
            </svg>
            <%= t("filters.has_audio", default: "Audio Tour") %>
          </label>
        <% end %>

        <%# Rating filter %>
        <% if show_rating %>
          <select name="min_rating"
                  data-action="change->listing-filters#filterChanged"
                  class="px-4 py-2.5 rounded-xl border-0 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium focus:ring-2 focus:ring-blue-500">
            <option value=""><%= t("filters.any_rating", default: "Any Rating") %></option>
            <option value="4" <%= 'selected' if params[:min_rating] == '4' %>>4+ &#9733;</option>
            <option value="3" <%= 'selected' if params[:min_rating] == '3' %>>3+ &#9733;</option>
            <option value="2" <%= 'selected' if params[:min_rating] == '2' %>>2+ &#9733;</option>
          </select>
        <% end %>

        <%# Clear all filters %>
        <% if has_active_filters %>
          <button type="button"
                  data-action="click->listing-filters#clearAll"
                  class="inline-flex items-center px-4 py-2.5 rounded-xl font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 transition-all">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <%= t("filters.clear_all", default: "Clear All") %>
          </button>
        <% end %>
      </div>

      <%# Nearby status message %>
      <div data-listing-filters-target="nearbyStatus" class="hidden text-sm"></div>
    <% end %>
    </div>
  </div>

  <%# Active filters badges %>
  <% if has_active_filters %>
    <div class="mt-4 flex flex-wrap gap-2 items-center">
      <span class="text-sm text-gray-600 dark:text-gray-400"><%= t("filters.active", default: "Active filters:") %></span>

      <% if nearby_active %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-sm font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          </svg>
          <%= t("filters.nearby", default: "Nearby") %>
        </span>
      <% end %>

      <% if local_assigns[:selected_city_name] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-full text-sm font-medium">
          <%= local_assigns[:selected_city_name] %>
        </span>
      <% end %>

      <% if local_assigns[:type_filter] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-full text-sm font-medium">
          <%= t("locations.types.#{local_assigns[:type_filter]}", default: local_assigns[:type_filter].humanize) %>
        </span>
      <% end %>

      <% if local_assigns[:budget_filter] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 rounded-full text-sm font-medium">
          <%= t("locations.budget.#{local_assigns[:budget_filter]}", default: local_assigns[:budget_filter].humanize) %>
        </span>
      <% end %>

      <% if local_assigns[:category] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full text-sm font-medium">
          <%= local_assigns[:category].name %>
        </span>
      <% end %>

      <% if local_assigns[:duration_filter] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-full text-sm font-medium">
          <%= t("filters.duration_#{local_assigns[:duration_filter]}", default: local_assigns[:duration_filter].humanize) %>
        </span>
      <% end %>

      <% if local_assigns[:audio_filter_active] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-violet-100 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300 rounded-full text-sm font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.728-2.728"></path>
          </svg>
          <%= t("filters.has_audio", default: "Audio Tour") %>
        </span>
      <% end %>

      <% if local_assigns[:rating_filter] %>
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-sm font-medium">
          <%= local_assigns[:rating_filter] %>+ &#9733;
        </span>
      <% end %>
    </div>
  <% end %>
</div>
