<%= form_with model: [:curator, location], class: "space-y-6", html: { multipart: true } do |f| %>
  <% if location.errors.any? %>
    <div class="rounded-md bg-red-50 p-4">
      <div class="text-sm text-red-700">
        <ul class="list-disc pl-5 space-y-1">
          <% location.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <%# Basic Information Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.basic_info", default: "Basic Information") %></h3>
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <div>
        <%= f.label :name, t("curator.locations.name"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" %>
      </div>

      <div>
        <%= f.label :city, t("curator.locations.city"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :city,
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm",
            placeholder: t("curator.locations.city_placeholder", default: "e.g. Sarajevo"),
            list: "city_suggestions" %>
        <datalist id="city_suggestions">
          <% @city_names.each do |name| %>
            <option value="<%= name %>">
          <% end %>
        </datalist>
      </div>

      <div>
        <%= f.label :location_type, t("curator.locations.type"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.select :location_type,
            options_for_select(Location.location_types.keys.map { |t| [t("locations.types.#{t}", default: t.humanize), t] }, location.location_type),
            {},
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" %>
      </div>

      <div>
        <%= f.label :budget, t("curator.locations.budget"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.select :budget,
            options_for_select(Location.budgets.keys.map { |b| [t("locations.budget.#{b}", default: b.humanize), b] }, location.budget),
            {},
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" %>
      </div>

      <div class="sm:col-span-2">
        <%= f.label :description, t("curator.locations.description"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_area :description, rows: 5, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" %>
      </div>

      <div class="sm:col-span-2">
        <%= f.label :historical_context, t("curator.locations.historical_context", default: "Historical Context"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_area :historical_context, rows: 4, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm" %>
        <p class="mt-1 text-xs text-gray-500"><%= t("curator.locations.historical_context_hint", default: "Historical background and significance of this location") %></p>
      </div>
    </div>
  </div>

  <%# Location & Coordinates Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.location", default: "Location & Coordinates") %></h3>
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <div>
        <%= f.label :lat, t("curator.locations.latitude", default: "Latitude"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.number_field :lat, step: "any", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "e.g. 43.8563" %>
      </div>

      <div>
        <%= f.label :lng, t("curator.locations.longitude", default: "Longitude"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.number_field :lng, step: "any", class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "e.g. 18.4131" %>
      </div>
    </div>
  </div>

  <%# Contact Information Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.contact", default: "Contact Information") %></h3>
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <div>
        <%= f.label :phone, t("curator.locations.phone"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.text_field :phone, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "+387 33 123 456" %>
      </div>

      <div>
        <%= f.label :email, t("curator.locations.email"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.email_field :email, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "contact@example.com" %>
      </div>

      <div class="sm:col-span-2">
        <%= f.label :website, t("curator.locations.website"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.url_field :website, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "https://example.com" %>
      </div>

      <div class="sm:col-span-2">
        <%= f.label :video_url, t("curator.locations.video_url", default: "Video URL"), class: "block text-sm font-medium text-gray-700" %>
        <%= f.url_field :video_url, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm", placeholder: "https://youtube.com/watch?v=..." %>
        <p class="mt-1 text-xs text-gray-500"><%= t("curator.locations.video_url_hint", default: "YouTube or other video link about this location") %></p>
      </div>
    </div>
  </div>

  <%# Social Links Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.social", default: "Social Media") %></h3>
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <% Location.supported_social_platforms.each do |platform| %>
        <div>
          <%= f.label "social_links_#{platform}", t("locations.social.#{platform}", default: platform.humanize), class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_field "social_links[#{platform}]",
              value: location.social_links[platform],
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm",
              placeholder: "https://#{platform}.com/..." %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Experience Types Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.experiences", default: "Suitable Experience Types") %></h3>
    <p class="text-sm text-gray-500 mb-4"><%= t("curator.locations.experiences_hint", default: "Select what types of experiences this location is suitable for") %></p>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
      <% @experience_types.each do |exp_type| %>
        <label class="flex items-center space-x-2 cursor-pointer">
          <%= check_box_tag "location[suitable_experiences][]", exp_type.key, location.suitable_experiences.include?(exp_type.key), class: "rounded border-gray-300 text-emerald-600 focus:ring-emerald-500" %>
          <span class="text-sm text-gray-700"><%= exp_type.name %></span>
        </label>
      <% end %>
    </div>
  </div>

  <%# Tags Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.tags", default: "Tags") %></h3>
    <div>
      <%= f.label :tags_input, t("curator.locations.tags", default: "Tags"), class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :tags_input,
          value: location.tags.join(", "),
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm",
          placeholder: t("curator.locations.tags_placeholder", default: "e.g. nature, historic, family-friendly") %>
      <p class="mt-1 text-xs text-gray-500"><%= t("curator.locations.tags_hint", default: "Separate tags with commas") %></p>
    </div>
  </div>

  <%# Photos Section %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.photos", default: "Photos") %></h3>

    <% if location.persisted? && location.photos.attached? %>
      <div class="mb-4">
        <p class="text-sm text-gray-500 mb-2"><%= t("curator.locations.current_photos", default: "Current photos") %> (<%= location.photos.count %>):</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
          <% location.photos.each do |photo| %>
            <div class="relative group">
              <%= image_tag rails_blob_path(photo, disposition: "inline"), class: "w-full h-32 object-cover rounded-lg" %>
              <label class="absolute top-2 right-2 bg-white rounded-full p-1 shadow cursor-pointer group-hover:opacity-100 transition-opacity">
                <%= check_box_tag "location[remove_photo_ids][]", photo.signed_id, false, class: "sr-only peer" %>
                <svg class="w-5 h-5 text-gray-400 peer-checked:text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </label>
            </div>
          <% end %>
        </div>
        <p class="mt-2 text-xs text-gray-500"><%= t("curator.locations.remove_photos_hint", default: "Click the trash icon to mark photos for removal") %></p>
      </div>
    <% end %>

    <div>
      <%= f.label :photos, t("curator.locations.add_photos", default: "Add Photos"), class: "block text-sm font-medium text-gray-700" %>
      <%= f.file_field :photos, multiple: true, accept: "image/*", class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" %>
      <p class="mt-1 text-xs text-gray-500"><%= t("curator.locations.photos_hint", default: "You can select multiple photos. Supported formats: JPG, PNG, WebP") %></p>
    </div>
  </div>

  <%# Audio Recording Section %>
  <% default_audio_tour = location.persisted? ? location.audio_tour_for("bs") : nil %>
  <% has_audio = default_audio_tour&.audio_file&.attached? %>
  <div class="bg-white rounded-lg shadow p-4 sm:p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4"><%= t("curator.locations.sections.audio", default: "Audio Recording") %></h3>

    <% if has_audio %>
      <div class="mb-4">
        <p class="text-sm text-gray-500 mb-2"><%= t("curator.locations.current_audio", default: "Current audio recording") %>:</p>
        <div class="flex items-center gap-4 bg-gray-50 rounded-lg p-3">
          <audio controls class="flex-grow">
            <source src="<%= url_for(default_audio_tour.audio_file) %>" type="<%= default_audio_tour.audio_file.content_type %>">
            <%= t("curator.locations.audio_not_supported", default: "Your browser does not support audio playback.") %>
          </audio>
          <label class="flex items-center gap-2 cursor-pointer text-sm text-gray-600 hover:text-red-500">
            <%= check_box_tag "location[remove_audio_file]", "1", false, class: "rounded border-gray-300 text-red-600 focus:ring-red-500" %>
            <%= t("curator.locations.remove_audio", default: "Remove") %>
          </label>
        </div>
        <p class="mt-2 text-xs text-gray-500">
          <%= default_audio_tour.audio_file.filename %> (<%= number_to_human_size(default_audio_tour.audio_file.byte_size) %>)
        </p>
      </div>
    <% end %>

    <div>
      <%= label_tag :audio_file, t("curator.locations.upload_audio", default: "Upload Audio Recording"), class: "block text-sm font-medium text-gray-700" %>
      <%= file_field_tag "location[audio_file]", accept: "audio/*", class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100" %>
      <p class="mt-1 text-xs text-gray-500"><%= t("curator.locations.audio_hint", default: "Supported formats: MP3, WAV, OGG. Max size: 50MB") %></p>
    </div>

    <% if location.persisted? && location.audio_tours.any? %>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
          <%= t("curator.locations.manage_audio_tours", default: "For multilingual audio tours, use the") %>
          <%= link_to t("curator.audio_tours.title", default: "Audio Tours"), curator_audio_tours_path(location_id: location.to_param), class: "text-emerald-600 hover:text-emerald-700 font-medium" %>
          <%= t("curator.locations.section", default: "section") %>.
        </p>
      </div>
    <% end %>
  </div>

  <div class="flex justify-end gap-3">
    <%= link_to t("common.cancel"), curator_locations_path,
        class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
    <%= f.submit t("common.save"), class: "rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 cursor-pointer" %>
  </div>
<% end %>
